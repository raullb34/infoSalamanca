<template>
  <div id="sidebar" :class="{ 'open': isOpen }">
    <div class="sidebar-header">
      <h2 id="town-name">{{ townName?.name || 'Selecciona un pueblo' }}</h2>
    </div>
    
    <div class="sidebar-content">
      <div id="town-info-container">
        <!-- Contenedor del mapa con banderas y escudos integrados -->
        <div id="town-map-section">
          <!-- Bandera a la izquierda -->
          <div id="town-flag" class="side-element left">
            <img v-if="townFlag && flagExists" :src="townFlag" @error="onFlagError" alt="Bandera del municipio" />
            <div v-else class="placeholder-element">üè¥</div>
          </div>
          
          <!-- Mapa central -->
          <div id="town-shape" ref="shapeContainer">
            <svg 
              v-if="townShape" 
              :viewBox="townShapeViewBox" 
              width="100%" 
              height="100%" 
              class="town-shape-svg"
              preserveAspectRatio="xMidYMid meet"
            >
              <path 
                :d="townShape.d" 
                :style="townShape.style"
                class="town-path"
              />
            </svg>
            <div v-else class="no-shape">
              <div class="shape-icon">üó∫Ô∏è</div>
              <p class="shape-text">{{ townName?.name || 'Municipio' }}</p>
            </div>
          </div>
          
          <!-- Escudo a la derecha -->
          <div id="town-shield" class="side-element right">
            <img v-if="townShield && shieldExists" :src="townShield" @error="onShieldError" alt="Escudo del municipio" />
            <div v-else class="placeholder-element">üõ°Ô∏è</div>
          </div>
        </div>
      </div>
      
      <div class="info-scroll">
        <!-- Informaci√≥n general -->
        <div id="info-content">
          <h3>Informaci√≥n</h3>
          
          <div v-if="isLoading" class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">Cargando informaci√≥n...</span>
          </div>
          <div v-else-if="municipioData" class="town-details">
            <p v-if="municipioData.poblacion">
              <strong>Poblaci√≥n:</strong> {{ municipioData.poblacion }} hab.
            </p>
            <p v-if="codPostal && codPostal !== 'N/A'">
              <strong>C√≥digo Postal:</strong> {{ codPostal }}
            </p>
            <p v-if="municipioData.latitud">
              <strong>Latitud:</strong> {{ municipioData.latitud }}¬∞ N
            </p>
            <p v-if="municipioData.longitud">
              <strong>Longitud:</strong> {{ municipioData.longitud }}¬∞ W
            </p>
            <p v-if="municipioData.superficie">
              <strong>Superficie:</strong> {{ municipioData.superficie }} km¬≤
            </p>
            <p v-if="municipioData.altitud">
              <strong>Altitud:</strong> {{ municipioData.altitud }} m
            </p>
            <p v-if="municipioData.densidad">
              <strong>Densidad:</strong> {{ municipioData.densidad }} hab/km¬≤
            </p>
            <div v-if="municipioData.mancomunidades" class="description">
              <h4>Mancomunidades</h4>
              <p>{{ municipioData.mancomunidades }}</p>
            </div>
            <div v-if="municipioData.comarca" class="description">
              <h4>Comarca</h4>
              <p>{{ municipioData.comarca }}</p>
            </div>
            <div v-if="municipioData.entidades_locales_menores" class="description">
              <h4>Entidades Locales Menores</h4>
              <p>{{ municipioData.entidades_locales_menores }}</p>
            </div>
          </div>
          <div v-else class="no-info">
            <p>No hay informaci√≥n disponible para este municipio.</p>
          </div>
        </div>
        
        <!-- Eventos -->
        <div id="events-container">
          <h3>Eventos</h3>
          <div v-if="events && events.length > 0">
            <div 
              v-for="event in events" 
              :key="event.id"
              class="event-item"
              @click="openEventDialog(event)"
            >
              <h4>{{ event.title || event.titulo }}</h4>
              <p v-if="event.date || event.fecha_inicio">
                üìÖ {{ formatDate(event.date || event.fecha_inicio) }}
              </p>
              <p v-if="event.location || event.ubicacion">
                üìç {{ event.location || event.ubicacion }}
              </p>
            </div>
          </div>
          <div v-else class="no-events">
            <p>No hay eventos programados.</p>
          </div>
        </div>
        
        <!-- Puntos de Inter√©s -->
        <div id="poi-container">
          <h3>¬øQu√© ver?</h3>
          <div v-if="pointsOfInterest && pointsOfInterest.length > 0">
            <div 
              v-for="poi in pointsOfInterest" 
              :key="poi.id"
              class="poi-item"
              @click="openPOIDialog(poi)"
            >
              <h4>{{ poi.name || poi.nombre }}</h4>
              <p v-if="poi.tipomonumento" class="poi-type">{{ poi.tipomonumento }}</p>
              <button 
                class="btn btn-sm btn-success add-to-route-btn"
                @click.stop="handleAddPOIToRoute(poi)"
              >
                + A√±adir a ruta
              </button>
            </div>
          </div>
          <div v-else class="no-pois">
            <p>No hay puntos de inter√©s disponibles.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- POI Dialog -->
  <POIDialog
    :isOpen="poiDialogOpen"
    :poi="selectedPOI"
    @close="closePOIDialog"
    @addToRoute="handleAddPOIToRoute"
  />
  
  <!-- Bot√≥n toggle para mostrar/ocultar sidebar -->
  <button 
    id="toggle-town-sidebar-btn" 
    class="btn btn-success"
    :class="{ 'collapsed': !isOpen }"
    @click="handleToggle"
    :style="{ right: isOpen ? '360px' : '10px' }"
    :title="isOpen ? 'Ocultar informaci√≥n' : 'Mostrar informaci√≥n'"
  >
    <div class="toggle-bars">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </button>
</template>

<script>
import { computed, ref, watch, nextTick, toRef, onMounted } from 'vue'
import { useTownStore } from '@/store/townStore'
import POIDialog from './POIDialog.vue'
import { apiService } from '@/services/apiService'

export default {
  name: 'TownSidebar',
  components: {
    POIDialog
  },
  props: {
    isOpen: {
      type: Boolean,
      default: false
    },
    townName: {
      type: Object,
      default: () => ({ id: '', name: '' })
    },
    townInfo: {
      type: Object,
      default: null
    },
    events: {
      type: Array,
      default: () => []
    },
    pointsOfInterest: {
      type: Array,
      default: () => []
    },
  },
  emits: ['close', 'openEventDialog', 'addPoiToRoute'],
  setup(props, { emit }) {
    const shapeContainer = ref(null)
    const townStore = useTownStore()
    const flagExists = ref(true)
    const shieldExists = ref(true)
    
    // Estados para manejar las extensiones de archivos
    const flagExtension = ref('.png')
    const shieldExtension = ref('.svg')
    
    // Estados para manejar el formato de nombres (espacios vs guiones bajos)
    const flagNameFormat = ref('spaces') // 'spaces' o 'underscores'
    const shieldNameFormat = ref('spaces') // 'spaces' o 'underscores'
    
    // Estado para manejar la forma del municipio
    const salamancaSvgData = ref(null)
    const townShape = ref(null)
    const townShapeViewBox = ref('0 0 800 600')
    
    // POI Dialog state
    const poiDialogOpen = ref(false)
    const selectedPOI = ref({})
    
    const isLoading = computed(() => townStore.isLoading)

    // M√©todo para cargar el SVG de Salamanca
    const loadSalamancaSvg = async () => {
      try {
        const response = await fetch('/Limites_salamanca.svg')
        const svgText = await response.text()
        salamancaSvgData.value = svgText
        extractTownShape()
      } catch (error) {
        console.error('Error loading Salamanca SVG:', error)
      }
    }

    // M√©todo para extraer la forma espec√≠fica del municipio
    const extractTownShape = () => {
      if (!salamancaSvgData.value || !props.townName?.id) {
        townShape.value = null
        return
      }

      try {
        // Crear un parser DOM para procesar el SVG
        const parser = new DOMParser()
        const svgDoc = parser.parseFromString(salamancaSvgData.value, 'image/svg+xml')
        
        // Buscar el path del municipio por su ID exacto
        const townPath = svgDoc.querySelector(`path[id="${props.townName.id}"]`)
        
        if (townPath) {
          processTownPath(townPath)
          console.log('TownSidebar - Town shape found for ID:', props.townName.id)
        } else {
          console.log('TownSidebar - Town path not found for ID:', props.townName.id)
          townShape.value = null
        }
      } catch (error) {
        console.error('Error extracting town shape:', error)
        townShape.value = null
      }
    }

    // M√©todo para procesar el path del municipio encontrado
    const processTownPath = (pathElement) => {
      const d = pathElement.getAttribute('d')
      
      if (d) {
        // Calcular el bounding box de la forma del municipio
        const bbox = calculatePathBoundingBox(d)
        
        // Usar el padding que sabemos que funciona
        const padding = Math.max(bbox.width, bbox.height) * 0.05
        
        townShapeViewBox.value = `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding * 2} ${bbox.height + padding * 2}`
        
        townShape.value = {
          d,
          style: `fill: var(--primary-color); stroke: var(--text-primary); stroke-width: 1; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));`
        }
        
        console.log('TownSidebar - Town shape visible for:', props.townName.name)
      }
    }

    // M√©todo mejorado para calcular el bounding box de un path
    const calculatePathBoundingBox = (pathData) => {
      // Usar una expresi√≥n regular m√°s precisa para extraer coordenadas
      const coordinateRegex = /-?\d*\.?\d+/g
      const coordinates = pathData.match(coordinateRegex)?.map(Number) || []
      
      if (coordinates.length < 4) {
        return { x: 0, y: 0, width: 800, height: 600 }
      }
      
      // Separar coordenadas X e Y
      const xCoords = []
      const yCoords = []
      
      // Procesar comandos de path para extraer solo las coordenadas de posici√≥n
      const commands = pathData.match(/[MLHVCSQTAZmlhvcsqtaz][^MLHVCSQTAZmlhvcsqtaz]*/g) || []
      
      commands.forEach(command => {
        const coords = command.slice(1).match(coordinateRegex)?.map(Number) || []
        const commandType = command[0].toLowerCase()
        
        if (commandType === 'm' || commandType === 'l' || commandType === 't') {
          // Move, Line, smooth curve commands
          for (let i = 0; i < coords.length; i += 2) {
            if (coords[i] !== undefined) xCoords.push(coords[i])
            if (coords[i + 1] !== undefined) yCoords.push(coords[i + 1])
          }
        } else if (commandType === 'c' || commandType === 's') {
          // Cubic bezier commands
          for (let i = 0; i < coords.length; i += 6) {
            if (coords[i + 4] !== undefined) xCoords.push(coords[i + 4])
            if (coords[i + 5] !== undefined) yCoords.push(coords[i + 5])
          }
        } else if (commandType === 'q') {
          // Quadratic bezier commands
          for (let i = 0; i < coords.length; i += 4) {
            if (coords[i + 2] !== undefined) xCoords.push(coords[i + 2])
            if (coords[i + 3] !== undefined) yCoords.push(coords[i + 3])
          }
        } else if (commandType === 'h') {
          // Horizontal line
          coords.forEach(coord => xCoords.push(coord))
        } else if (commandType === 'v') {
          // Vertical line
          coords.forEach(coord => yCoords.push(coord))
        }
      })
      
      if (xCoords.length === 0 || yCoords.length === 0) {
        // Fallback: usar todas las coordenadas pares/impares
        for (let i = 0; i < coordinates.length; i += 2) {
          if (coordinates[i] !== undefined) xCoords.push(coordinates[i])
          if (coordinates[i + 1] !== undefined) yCoords.push(coordinates[i + 1])
        }
      }
      
      const minX = Math.min(...xCoords)
      const maxX = Math.max(...xCoords)
      const minY = Math.min(...yCoords)
      const maxY = Math.max(...yCoords)
      
      return {
        x: minX,
        y: minY,
        width: maxX - minX,
        height: maxY - minY
      }
    }
    
    // Watch props changes for debugging
    watch(() => props.townInfo, (newTownInfo) => {
      console.log('TownSidebar - townInfo changed:', newTownInfo)
    }, { immediate: true })
    
    watch(() => props.townName, (newTownName) => {
      console.log('TownSidebar - townName changed:', newTownName)
      // Resetear los estados de existencia de im√°genes cuando cambia el municipio
      flagExists.value = true
      shieldExists.value = true
      // Resetear las extensiones a sus valores por defecto
      flagExtension.value = '.png'
      shieldExtension.value = '.svg'
      // Resetear los formatos de nombres a sus valores por defecto
      flagNameFormat.value = 'spaces'
      shieldNameFormat.value = 'spaces'
      // Extraer la nueva forma del municipio
      extractTownShape()
    }, { immediate: true })

    // Cargar el SVG de Salamanca al montar el componente
    onMounted(() => {
      loadSalamancaSvg()
    })
    
    const codPostal = computed(() => {
      const townData = props.townInfo?.results?.[0]
      return townData && Array.isArray(townData.cod_postal) && townData.cod_postal.length > 0
        ? townData.cod_postal[0]
        : 'N/A';
    })

    // Computed property para acceder a los datos del municipio
    const municipioData = computed(() => {
      return props.townInfo?.results?.[0] || null
    })

    const townFlag = computed(() => {
      if (!props.townName || !props.townName.id || !props.townName.name) return null
      
      // Normalizar nombre base
      const baseName = props.townName.name.toLowerCase()
        .replace(/\s+/g, ' ')
        .trim()
      
      // Aplicar formato seg√∫n el estado actual
      const normalizedName = flagNameFormat.value === 'spaces' 
        ? baseName 
        : baseName.replace(/\s/g, '_')
      
      const flagName = `${props.townName.id}_${normalizedName}`
      const flagPath = `/assets/flags/${flagName}_bandera${flagExtension.value}`
      console.log('TownSidebar - Flag path:', flagPath)
      console.log('TownSidebar - Format:', flagNameFormat.value, 'Extension:', flagExtension.value)
      return flagPath
    })

    const townShield = computed(() => {
      if (!props.townName || !props.townName.id || !props.townName.name) return null
      
      // Normalizar nombre base
      const baseName = props.townName.name.toLowerCase()
        .replace(/\s+/g, ' ')
        .trim()
      
      // Aplicar formato seg√∫n el estado actual
      const normalizedName = shieldNameFormat.value === 'spaces' 
        ? baseName 
        : baseName.replace(/\s/g, '_')
      
      const shieldName = `${props.townName.id}_${normalizedName}`
      const shieldPath = `/assets/shields/${shieldName}_shield${shieldExtension.value}`
      console.log('TownSidebar - Shield path:', shieldPath)
      console.log('TownSidebar - Format:', shieldNameFormat.value, 'Extension:', shieldExtension.value)
      return shieldPath
    })

    const handleClose = () => {
      emit('close')
    }

    const handleToggle = () => {
      emit('close')
    }

    const openEventDialog = (event) => {
      emit('openEventDialog', event)
    }

    const formatDate = (dateString) => {
      if (!dateString) return ''
      const date = new Date(dateString)
      return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    }

    // POI Dialog methods
    const openPOIDialog = (poi) => {
      selectedPOI.value = poi
      poiDialogOpen.value = true
    }

    const closePOIDialog = () => {
      poiDialogOpen.value = false
      selectedPOI.value = {}
    }

    const handleAddPOIToRoute = (poi) => {
      emit('addPoiToRoute', poi)
      closePOIDialog()
    }

    const onFlagError = () => {
      console.log('TownSidebar - Flag failed to load:', townFlag.value)
      
      // Primer intento: cambiar extensi√≥n manteniendo el formato
      if (flagExtension.value === '.png') {
        console.log('TownSidebar - Trying flag with .svg extension')
        flagExtension.value = '.svg'
        flagExists.value = true
      } 
      // Segundo intento: cambiar formato manteniendo la extensi√≥n
      else if (flagNameFormat.value === 'spaces') {
        console.log('TownSidebar - Trying flag with underscores format')
        flagNameFormat.value = 'underscores'
        flagExtension.value = '.png' // Resetear a .png para probar ambas extensiones con el nuevo formato
        flagExists.value = true
      }
      // Tercer intento: .svg con underscores
      else if (flagExtension.value === '.png') {
        console.log('TownSidebar - Trying flag with .svg extension and underscores')
        flagExtension.value = '.svg'
        flagExists.value = true
      }
      // Si ya probamos todas las combinaciones, marcar como no existe
      else {
        console.log('TownSidebar - Flag not found in any format')
        flagExists.value = false
      }
    }

    const onShieldError = () => {
      console.log('TownSidebar - Shield failed to load:', townShield.value)
      
      // Primer intento: cambiar extensi√≥n manteniendo el formato
      if (shieldExtension.value === '.svg') {
        console.log('TownSidebar - Trying shield with .png extension')
        shieldExtension.value = '.png'
        shieldExists.value = true
      } 
      // Segundo intento: cambiar formato manteniendo la extensi√≥n
      else if (shieldNameFormat.value === 'spaces') {
        console.log('TownSidebar - Trying shield with underscores format')
        shieldNameFormat.value = 'underscores'
        shieldExtension.value = '.svg' // Resetear a .svg para probar ambas extensiones con el nuevo formato
        shieldExists.value = true
      }
      // Tercer intento: .png con underscores
      else if (shieldExtension.value === '.svg') {
        console.log('TownSidebar - Trying shield with .png extension and underscores')
        shieldExtension.value = '.png'
        shieldExists.value = true
      }
      // Si ya probamos todas las combinaciones, marcar como no existe
      else {
        console.log('TownSidebar - Shield not found in any format')
        shieldExists.value = false
      }
    }

    return {
      isLoading,
      townName: toRef(props, 'townName'),
      townInfo: toRef(props, 'townInfo'),
      municipioData,
      events: toRef(props, 'events'),
      pointsOfInterest: toRef(props, 'pointsOfInterest'),
      townFlag,
      townShield,
      codPostal,
      flagExists,
      shieldExists,
      flagExtension,
      shieldExtension,
      flagNameFormat,
      shieldNameFormat,
      handleClose,
      handleToggle,
      openEventDialog,
      formatDate,
      onFlagError,
      onShieldError,
      shapeContainer,
      // Town shape
      townShape,
      townShapeViewBox,
      loadSalamancaSvg,
      extractTownShape,
      // POI Dialog
      poiDialogOpen,
      selectedPOI,
      openPOIDialog,
      closePOIDialog,
      handleAddPOIToRoute
    }
  }
}
</script>

<style scoped>
#sidebar {
  width: 370px;
  height: 100vh;
  position: fixed;
  right: -370px;
  top: 0;
  background: var(--bg-primary);
  box-shadow: -2px 0 20px var(--shadow-medium);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 0;
  display: flex;
  flex-direction: column;
  z-index: 1000;
  overflow-y: auto;
  backdrop-filter: blur(10px);
  border-left: 3px solid var(--primary-color);
}

#sidebar.open {
  right: 0;
}

/* Responsive adjustments for mobile */
@media (max-width: 767px) {
  #sidebar {
    width: 100vw;
    right: -100vw;
    z-index: 9999;
  }
  
  #sidebar.open {
    right: 0;
  }
}

/* Header section */
.sidebar-header {
  background: var(--bg-header);
  color: var(--text-light);
  padding: 20px;
  position: sticky;
  top: 0;
  z-index: 100;
}

#close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: var(--text-light);
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

#close-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.05);
}

#town-name {
  margin: 0;
  font-size: 1.5em;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  padding-right: 60px;
  color: var(--text-light);
}

.sidebar-content {
  flex: 1;
  padding: 0;
  overflow-y: auto;
}

.info-scroll {
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  padding: 20px;
}

/* Town map section with integrated flags and shields */
#town-map-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding: 15px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border-secondary);
}

/* Town shape container - now in the center */
#town-shape {
  flex: 1.5; /* Hacer el contenedor m√°s grande */
  min-height: 180px; /* Aumentar la altura */
  background: var(--bg-tertiary);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--border-primary);
  position: relative;
  overflow: hidden;
  padding: 0; /* Sin padding interno */
}

/* Side elements (flags and shields) */
.side-element {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 90px; /* Volver al tama√±o original */
  transition: transform 0.2s ease;
}

.side-element:hover {
  transform: scale(1.05);
}

.side-element.left {
  order: 1;
}

.side-element.right {
  order: 3;
}

#town-shape {
  order: 2;
}

/* Nuevos estilos para el SVG del municipio */
.town-shape-svg {
  width: 100%;
  height: 100%;
  padding: 5px; /* Padding que funcionaba */
  display: block;
  margin: auto;
}

.town-path {
  transition: all 0.3s ease;
  cursor: pointer;
  transform-origin: center center;
}

.town-path:hover {
  filter: brightness(1.1) drop-shadow(4px 4px 8px rgba(0,0,0,0.4)) !important;
  transform: scale(1.02); /* Peque√±o efecto de hover */
}

.no-shape {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  min-height: 120px; /* Volver al tama√±o original */
}

.shape-icon {
  font-size: 48px; /* Volver al tama√±o original */
  margin-bottom: 8px; /* Volver al margen original */
  opacity: 0.6;
}

.shape-text {
  color: var(--primary-color);
  font-weight: 600;
  font-size: 14px; /* Volver al tama√±o original */
  text-align: center;
  margin: 8px 0 0 0; /* Volver al margen original */
}

/* Flags and shields - now integrated in the map section */
#town-flag img,
#town-shield img {
  width: 80px; /* Volver al tama√±o original */
  height: 80px;
  object-fit: contain;
  transition: all 0.2s ease;
}

#town-flag img:hover,
#town-shield img:hover {
  transform: scale(1.05);
}

/* Placeholder for missing flags and shields */
.placeholder-element {
  width: 80px; /* Volver al tama√±o original */
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px; /* Volver al tama√±o original */
  background: var(--hover-bg);
  border-radius: 8px;
  border: 2px dashed var(--border-secondary);
  transition: all 0.2s ease;
  color: var(--text-muted);
}

.placeholder-element:hover {
  transform: scale(1.05);
  background: var(--active-bg);
}

/* Responsive adjustments for the map section */
@media (max-width: 480px) {
  #town-map-section {
    flex-direction: column;
    gap: 10px;
    padding: 10px;
  }
  
  .side-element {
    order: unset !important;
    min-width: unset;
  }
  
  .side-element.left {
    order: 1;
  }
  
  #town-shape {
    order: 2;
    min-height: 120px;
  }
  
  .side-element.right {
    order: 3;
  }
  
  #town-flag img,
  #town-shield img {
    width: 70px;
    height: 70px;
  }
  
  .placeholder-element {
    width: 70px;
    height: 70px;
    font-size: 35px;
  }
}

/* Info sections */
.town-details p {
  margin: 10px 0;
  padding: 8px 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 14px;
  color: var(--text-secondary);
}

.town-details p:last-child {
  border-bottom: none;
}

.town-details strong {
  color: var(--primary-color);
  font-weight: 600;
}

.description {
  background: var(--bg-secondary);
  border-radius: 8px;
  margin: 15px 0;
  padding: 15px;
  border-left: 4px solid var(--primary-color);
}

.description h4 {
  margin: 0 0 10px 0;
  color: var(--primary-color);
  font-size: 1.1em;
  font-weight: 600;
}

.description p {
  margin: 0;
  line-height: 1.5;
  color: var(--text-tertiary);
}

h3 {
  color: var(--text-primary);
  border-bottom: 2px solid var(--primary-color);
  padding-bottom: 8px;
  margin: 25px 0 15px 0;
  font-size: 1.2em;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

h3::before {
  font-size: 1.2em;
}

#info-content h3::before {
  content: "‚ÑπÔ∏è";
}

#events-container h3::before {
  content: "üé≠";
}

#poi-container h3::before {
  content: "üëÅÔ∏è";
}

/* Event and POI items */
.event-item,
.poi-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

.event-item:hover,
.poi-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--primary-color);
  background: var(--bg-hover);
}

.event-item h4,
.poi-item h4 {
  margin: 0 0 8px 0;
  color: var(--text-primary);
  font-size: 1.1em;
  font-weight: 600;
}

.event-item p,
.poi-item p {
  margin: 5px 0;
  color: var(--text-secondary);
  font-size: 14px;
}

.poi-type {
  font-style: italic;
  font-size: 12px;
  color: var(--accent-color);
}

.add-to-route-btn {
  margin-top: 10px;
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 4px;
  background: var(--primary-color);
  color: var(--bg-primary);
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.add-to-route-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.no-info,
.no-events,
.no-pois {
  text-align: center;
  color: var(--text-secondary);
  font-style: italic;
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin: 15px 0;
  border: 1px solid var(--border-light);
}

.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  font-style: normal;
  color: var(--text-secondary);
  padding: 20px;
  background: var(--bg-secondary);
  border-radius: 8px;
  margin: 15px 0;
  border: 1px solid var(--border-light);
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-light);
  border-top: 2px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  flex-shrink: 0;
}

.loading-text {
  animation: none !important;
  transform: none !important;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Scrollbar personalizada */
.info-scroll::-webkit-scrollbar {
  width: 6px;
}

.info-scroll::-webkit-scrollbar-track {
  background: var(--border-light);
  border-radius: 3px;
}

.info-scroll::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 3px;
}

.info-scroll::-webkit-scrollbar-thumb:hover {
  background: var(--primary-hover);
}

/* Bot√≥n toggle para TownSidebar */
#toggle-town-sidebar-btn {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1001;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--primary-color);
  color: var(--text-light);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(10px);
}

#toggle-town-sidebar-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-50%) scale(1.1);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
}

#toggle-town-sidebar-btn:active {
  transform: translateY(-50%) scale(0.95);
}

#toggle-town-sidebar-btn.collapsed {
  background: var(--accent-color);
}

#toggle-town-sidebar-btn .toggle-bars {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 18px;
  height: 18px;
  transition: all 0.3s ease;
}

#toggle-town-sidebar-btn .toggle-bars span {
  position: absolute;
  width: 14px;
  height: 2px;
  background: var(--text-light);
  border-radius: 1px;
  transition: all 0.3s ease;
}

/* Cuando est√° abierto - mostrar X */
#toggle-town-sidebar-btn:not(.collapsed) .toggle-bars span:nth-child(1) {
  transform: rotate(45deg);
}

#toggle-town-sidebar-btn:not(.collapsed) .toggle-bars span:nth-child(2) {
  opacity: 0;
}

#toggle-town-sidebar-btn:not(.collapsed) .toggle-bars span:nth-child(3) {
  transform: rotate(-45deg);
}

/* Cuando est√° cerrado - mostrar flecha izquierda */
#toggle-town-sidebar-btn.collapsed .toggle-bars span:nth-child(1) {
  transform: rotate(-45deg) translateY(-3px);
}

#toggle-town-sidebar-btn.collapsed .toggle-bars span:nth-child(2) {
  transform: rotate(45deg) translateY(3px);
}

#toggle-town-sidebar-btn.collapsed .toggle-bars span:nth-child(3) {
  opacity: 0;
}

/* Mobile adjustments for toggle button */
@media (max-width: 767px) {
  #toggle-town-sidebar-btn {
    top: 20px;
    right: 20px !important;
    transform: none;
    width: 45px;
    height: 45px;
    z-index: 10000;
  }
  
  #toggle-town-sidebar-btn:hover {
    transform: scale(1.1);
  }
  
  #toggle-town-sidebar-btn .toggle-bars {
    width: 16px;
    height: 16px;
  }
  
  #toggle-town-sidebar-btn .toggle-bars span {
    width: 12px;
  }
}
</style>